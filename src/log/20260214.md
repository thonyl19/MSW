# MSW 系統演化與優化報告 (2026-02-14)

今日針對 MSW (Mock Service Worker) 測試環境進行了一系列深度重構，旨在提升系統的**靈活性**、**安全性**、**開發體驗**以及**代碼內聚性**。

## 1. 核心功能演進

### A. API 攔截開關 (Global Toggle)
- **需求**：能夠在不重新整理頁面的情況下，隨時切換「Mock 模式」與「真正後端模式」。
- **實作**：
    - 在 `MockPanel.js` 介面頂部新增「啟用 MSW 攔截」開關。
    - 透過 `mock-entry.js` 動態呼叫 `worker.start()` 與 `worker.stop()` 控制拦截生命週期。
    - 狀態持久化：使用 `localStorage` 記錄開關狀態，確保重新整理頁面後設定不丟失。

### B. 自動化載入器 (MSW Loader)
- **需求**：簡化 HTML 中的配置，避免手動撰寫複雜的 `importmap` 與路徑設定。
- **實作**：
    - 開發 `msw-loader.js`，實現「一行引入」：`<script src=".../msw-loader.js" data-page="operation"></script>`。
    - **動態路徑偵測**：自動根據 `loader` 所在的真實位址推導 `baseUrl`，支援虛擬目錄（如 `/ZACMES/`）自動適配。
    - **安全性檢查**：載入前自動發送 `HEAD` 請求檢查 `msw-core.js` 是否存在，若無則靜默退出，防止 404 報錯影響正常業務。

### C. Vue 環境對接 (Vue Bridge)
- **需求**：若主體環境已有 Vue (UMD/CDN)，則應直接復用，避免重複載入與狀態不同步。
- **實作**：
    - 在 `importmap` 生成時，偵測 `window.Vue` 是否存在。
    - 若存在，透過 `Data URI` 將全域 Vue 導出為 ESM，確保全系統共用同一個 Vue 實例與響應式系統。

## 2. 架構重構：高內聚設計 (High Cohesion)

### 從「分散式」轉向「頁面自註冊」
- **舊架構**：UI 定義在 `pages/`，攔截邏輯寫在全域 `handlers.js`，開發需切換多處。
- **新架構**：
    - **`registerMock` API**：在 `mock-entry.js` 提供統一入口，允許頁面同時傳入 `controls` (UI) 與 `handlers` (API 邏輯)。
    - **頁面模組化**：以 `operation.js` 為例，現在一個檔案就包含了該頁面所有的 Mock 規格。
    - **動態插拔**：利用 MSW 的 `worker.use()` 實現頁面專屬 logic 的動態注入，優先權高於全域設定。

## 3. 開發工作流改進

### A. 免編譯模式 (No-Build Workflow)
- **實作**：利用 Windows `mklink` (Symbolic Link) 將開發目錄 `src` 直接對接到專案的 `wwwroot`。
- **效益**：
    - 修改 `src` 代碼後無需手動編譯或複製，瀏覽器重新整理即生效。
    - `build.js` 職責簡化為僅處理 `msw` 核心庫的打包。

## 4. 檔案變動清單

| 檔案 | 主要變動 |
| :--- | :--- |
| `src/components/MockPanel.js` | 新增攔截開關 UI、樣式優化、狀態連動。 |
| `src/msw-loader.js` | **(New)** 自動徑偵測、安全檢查、Vue 對接、ImportMap 注入。 |
| `src/mock-entry.js` | 實作 `registerMock`、動態控制 Worker 啟閉。 |
| `src/store.js` | 支援 `isEnabled` 狀態持久化。 |
| `src/pages/operation.js` | 重構為高內聚模式，整合 API 攔截邏輯。 |
| `src/handlers.js` | 瘦身，僅保留全域通用攔截器。 |
| `build.js` | 簡化流程，配合 `mklink` 工作流。 |

---
**報告人：** Antigravity AI
**日期：** 2026-02-14
